$.fn.eventCalendar=function(options){function sortJson(e,t){return e.u.toLowerCase()>t.u.toLowerCase()?1:-1}function dateSlider(e,t,a){var n=$("<div class='eventsCalendar-slider'></div>"),s=$("<div class='eventsCalendar-monthWrap'></div>"),r=$("<div class='eventsCalendar-currentTitle'><span href='#' class='monthTitle'></span></div>"),l=$("<a href='#' class='arrow prev' onclick='showLoading(\"prev month click\");'><span>"+eventsOpts.txt_prev+"</span></a><a href='#' class='arrow next' onclick='showLoading(\"next month click\");'><span>"+eventsOpts.txt_next+"</span></a>");if($eventsCalendarArrowsCurrent=$("<span>"+eventsOpts.txt_prev+"</span></a><a href='#' class='arrow next' onclick='showLoading(\"next month #2 click\");'><span>"+eventsOpts.txt_next+"</span></a>"),$eventsCalendarDaysList=$("<ul class='eventsCalendar-daysList'></ul>"),eventsOpts.showFromDate?date=eventsOpts.showFromDate:date=new Date,flags.wrap.find(".eventsCalendar-slider").size()?flags.wrap.find(".eventsCalendar-slider").append(s):(flags.wrap.prepend(n),n.append(s)),flags.wrap.find(".eventsCalendar-monthWrap.currentMonth").removeClass("currentMonth").addClass("oldMonth"),s.addClass("currentMonth").append(r,$eventsCalendarDaysList),"current"===e)day=date.getDate(),n.append(l);else{date=new Date(flags.wrap.attr("data-current-year"),flags.wrap.attr("data-current-month"),1,0,0,0),day=0,moveOfMonth=1,"prev"===e&&(moveOfMonth=-1),date.setMonth(date.getMonth()+moveOfMonth);var o=new Date;date.getMonth()===o.getMonth()&&(day=o.getDate())}date.getFullYear()==(new Date).getFullYear()&&$("a.prev").fadeOut();t=date.getFullYear();var i=(new Date).getFullYear();a=date.getMonth();if("current"!=e){var d=new Date;a!=d.getMonth()&&$("a.prev").fadeIn(),getEvents(eventsOpts.eventsLimit,t,a,!1,e)}flags.wrap.attr("data-current-month",a).attr("data-current-year",t),r.find(".monthTitle").html(eventsOpts.monthNames[a]+" "+t);var v=32-new Date(t,a,32).getDate(),h=[];if(eventsOpts.showDayAsWeeks){if($eventsCalendarDaysList.addClass("showAsWeek"),eventsOpts.showDayNameInCalendar){$eventsCalendarDaysList.addClass("showDayNames");var c=0;for(eventsOpts.startWeekOnMonday&&(c=1);c<7;c++)h.push('<li class="eventsCalendar-day-header">'+eventsOpts.dayNamesShort[c]+"</li>"),6===c&&eventsOpts.startWeekOnMonday&&h.push('<li class="eventsCalendar-day-header">'+eventsOpts.dayNamesShort[0]+"</li>")}dt=new Date(t,a,1);var p=dt.getDay();for(eventsOpts.startWeekOnMonday&&(p=dt.getDay()-1),p<0&&(p=6),c=p;c>0;c--)h.push('<li class="eventsCalendar-day empty"></li>')}for(dayCount=1;dayCount<=v;dayCount++){var u="";day>0&&dayCount===day&&t===i&&a===(new Date).getMonth()&&(u="current"),dayCount<day&&(u="dayPast disabled"),h.push('<li id="dayList_'+dayCount+'" rel="'+dayCount+'" class="eventsCalendar-day '+u+'"><a href="javascript:void(0)">'+dayCount+"</a></li>")}$eventsCalendarDaysList.append(h.join("")),n.css("height",s.height()+"px")}function num_abbrev_str(e){var t,a=e.length,n=e.charAt(a-1);return t=2===a&&"1"===e.charAt(0)?"th":"1"===n?"st":"2"===n?"nd":"3"===n?"rd":"th",e+t}function getEvents(e,t,a,n,s){e=e||0,t=t||"",n=n||"";if(void 0!==a)a=a;else a="";if(setCalendarWidgetHeight(),eventsOpts.jsonData)eventsOpts.cacheJson=!0,flags.eventsJson=eventsOpts.jsonData,getEventsData(flags.eventsJson,e,t,a,n,s);else if(eventsOpts.cacheJson&&s&&"next"!=s&&"prev"!=s)getEventsData(flags.eventsJson,e,t,a,n,s),hideLoading("last","free");else{var r=t;r||(r="false");var l=a;!1!==l&&l++;var o=new Date(t,a,1,0,0,0,0);stopSkipMonthLoad=!1,eventsOpts.showToDate&&(o.getTime()>=eventsOpts.showToDate.getTime()?($("a.arrow.next").hide(),stopSkipMonthLoad=!0):$("a.arrow.next").show()),eventsOpts.showFromDate&&(o.getTime()>eventsOpts.showFromDate.getTime()?$("a.arrow.prev").show():$("a.arrow.prev").hide()),flags.eventsJson=getFallbackEvents(r,l),fallbackEventsMode&&void 0!==flags.eventsJson&&!1!==flags.eventsJson?(getEventsData(flags.eventsJson,e,t,a,n,s),hideLoading("fallback")):(showLoading("new ajax event","busy"),eventsOpts.widget_backoffice?url_route=eventsOpts.eventsjson+"/"+l+"/"+r+"/1/1":url_route=eventsOpts.eventsjson+"/"+l+"/"+r+"/1/0",$.ajax({url:url_route,cache:!1,dataType:"jsonp",timeout:6e4,tryCount:0,retryLimit:3,jsonp:!1,jsonpCallback:"eventsJSON",success:function(r,l){flags.eventsJson=r,getEventsData(flags.eventsJson,e,t,a,n,s),hideLoading("ajax success","free");var o=parseInt(a);o+=1,o<10&&(o="0"+o);var i=$("#tour_events_cache").html();t&&o&&(i+="\n events_cache["+t+o+"]="+JSON.stringify(r)+";",i=i.replace(/true/g,"1"),$("#tour_events_cache").html(i))},error:function(o,i,d){if("timeout"===i)return hideLoading("ajax timeout","free"),this.tryCount++,this.tryCount<=this.retryLimit?void $.ajax(this):void 0;hideLoading("ajax error","free"),flags.eventsJson=getFallbackEvents(r,l),getEventsData(flags.eventsJson,e,t,a,n,s)}}))}}function getFallbackEvents(call_year,call_month){var key_year,key_month;if(fallbackEventsMode=!0,call_year&&call_month&&(key_month=call_month,key_year=call_year),!key_year||!key_month){var t=new Date,m=t.getMonth();key_year=t.getFullYear(),key_month=parseInt(m)+1,key_month=key_month.toString()}key_month=key_month.toString(),1==key_month.length&&(key_month="0"+key_month),eventsJson=new Object;var cache_content=$("#tour_events_cache").html();if(eval(cache_content),void 0!==events_cache[key_year+key_month]){var eventsJson=events_cache[key_year+key_month];return eventsJson}return!1}function getEventsData(e,t,a,n,s,r){directionLeftMove="-="+flags.directionLeftMove,eventContentHeight="auto",subtitle=flags.wrap.find(".eventsCalendar-list-wrap .eventsCalendar-subtitle"),r?"prev"===r?directionLeftMove="+="+flags.directionLeftMove:"day"!==r&&"month"!==r||(directionLeftMove="+=0",eventContentHeight=0):(subtitle.html(eventsOpts.txt_NextEvents),eventContentHeight="auto",directionLeftMove="-=0"),flags.wrap.find(".eventsCalendar-list").animate({opacity:eventsOpts.moveOpacity,left:directionLeftMove,height:eventContentHeight},eventsOpts.moveSpeed,function(){flags.wrap.find(".eventsCalendar-list").css({left:0,height:"auto"}).hide();var r=[];if(e=$(e).sort(sortJson),e.length){blankMonthAutoSkips=eventsOpts.blankMonthAutoSkips;eventsOpts.showDescription||"hidden";eventsOpts.openEventInNewWindow&&"_target";var l=0,o=!0,i=new Array,d=new Array,v=new Array,h=!1,c=1==$("input[name=show_closed_by_availability]").val();if($.each(e,function(e,p){if(!p.d||""==p.d||""==p.h)return!0;if(1==p.s)null==i[p.d]?i[p.d]=1:i[p.d]++;else{null==i[p.d]&&(i[p.d]=0);var u=(p.s.match(/closed/g)||[]).length;if(1==u){var g=parseInt(p.u)<parseInt((new Date).getTime()/1e3);!g&&(p.s.indexOf("Toolateforonlinesales")>1||p.s.match(/Too late for online sales/g))&&null==d[p.d]&&(d[p.d]=1),p.s.indexOf("event_started")>1&&null==v[p.d]&&(v[p.d]=1)}}var f=p.d.replace(/-.*$/g,""),y=p.d.replace(/^\d\d\d\d-|-\d\d$/g,"");y.match(/^0\d$/)&&(y=y.replace(/0/,"")),y=parseInt(y)-1;var m=p.d.replace(/^.*-/g,"");m=m.replace(/^0/,"");var w=convertTimeTo24(p.h),C=w.replace(/:\d\d$/,""),_=w.replace(/^[\d]?\d:/,""),$=new Date(f,y,m,C,_,0,0);if(0===t||t>l){var b=y+1;C=$.getHours(),_=$.getMinutes();if(_<=9&&(_="0"+_),!(!1!==n&&n!=y||""!=s&&s!=m||""!=a&&a!=f))if(o=!1,!1===n&&$<new Date);else{if(eventStringDate=m+"/"+b+"/"+f,1!=p.s){u=(p.s.match(/closed/g)||[]).length;if((p.s.indexOf("Toolateforonlinesales")>1||p.s.match(/Too late for online sales/g))&&1==u){var k=new Date;$>=k?c?r.push('<label title="'+eventsOpts.txt_CallToConsultAvailabilty+'" class="event-label-closed too-late"><span id="'+e+'" class="event">'+p.h+"</span></label> "):r.push('<label title="'+eventsOpts.txt_NotAvailable+'" class="event-label-closed too-late"><span id="'+e+'" class="event">'+p.h+"</span></label> "):r.push('<label class="event-label-closed"><span id="'+e+'" class="event">'+p.h+"</span></label> ")}else p.s.indexOf("event_started")>1?r.push('<label class="event-label-closed event_started" title="'+eventsOpts.txt_NotAvailable+'"><span id="'+e+'" class="event" title="'+eventsOpts.txt_NotAvailable+'">'+p.h+"</span></label> "):r.push('<label class="event-label-closed" title="'+eventsOpts.txt_NotAvailable+'"><span id="'+e+'" class="event" title="'+eventsOpts.txt_NotAvailable+'">'+p.h+"</span></label> ")}else r.push('<label class="event-label" id="event_label_'+p.h.replace(/[^0-9apm]/,"")+'" onclick="updateBox(\''+p.d+"','"+p.h+'\');"><span id="'+e+'" class="event"><input style="display:none" class="hour-to-select" type="radio" id="hour-'+p.d+'" name="hour-to-select" value="'+p.h+'" />'+p.h+"</span></label> ");l++}}parseInt(p.hide)&&1==p.s&&void 0===flags.wrap.find(".currentMonth #dayList_"+m).data("hour")&&(h=!0,flags.wrap.find(".currentMonth #dayList_"+m).addClass("calendar-hide-hour"),flags.wrap.find(".currentMonth #dayList_"+m).attr("data-hour",p.h),flags.wrap.find(".currentMonth #dayList_"+m).attr("data-hide-hour",1)),f==flags.wrap.attr("data-current-year")&&y==flags.wrap.attr("data-current-month")&&flags.wrap.find(".currentMonth .eventsCalendar-daysList #dayList_"+m).addClass("dayWithEvents")}),h)for(var p in i)if(!i[p]){var u=p.substring(p.length-2,p.length).trim("0").replace(/^0/,"");$("#dayList_"+u+" > a").click(function(){return!1})}var g=!0;for(var f in i)if(i.hasOwnProperty(f)){var y=f.replace(/.*-/,"");y=y.replace(/^0/,""),0==i[f]?($("li#dayList_"+y).removeClass("dayWithEvents"),$("li#dayList_"+y).addClass("dayClosed disabled"),null!=d[f]&&1==d[f]&&$("li#dayList_"+y).addClass("too-late"),null!=v[f]&&1==v[f]&&$("li#dayList_"+y).addClass("event-started"),null!=d[f]&&1==d[f]&&c?($("li#dayList_"+y).attr("title",eventsOpts.txt_CallToConsultAvailabilty),$("li#dayList_"+y).addClass("too-late").removeClass("disabled").addClass("dayWithEvents")):($("li#dayList_"+y+" a").click(function(){return!1}),$("li#dayList_"+y).attr("title",eventsOpts.txt_NotAvailable))):g=!1}g&&eventsOpts.blankMonthAutoSkips&&!eventsOpts.showClosedByAvailability&&!stopSkipMonthLoad&&(setTimeout(function(){$("a."+blankMonthAutoSkipsDirection).trigger("click")},550),eventsOpts.blankMonthAutoSkips--);var m=new Date,w=m.getFullYear(),C=("0"+(m.getMonth()+1)).substr(-2),_=("0"+m.getDate()).substr(-2),b=(_=("0"+m.getDate()).substr(-2),w+"-"+C+"-"+_),k=Date.parse(m);for(y=1;y<=31;y++){aux_d=y,parseInt(aux_d)<10&&(aux_d="0"+aux_d),aux_m=parseInt(n)+1,parseInt(aux_m)<10&&(aux_m="0"+aux_m);var x=a+"-"+aux_m+"-"+aux_d,O=Date.parse(x);O<k&&x!=b&&$("li#dayList_"+y).addClass("dayPast"),null==i[x]&&$("li#dayList_"+y).addClass("dayEmpty disabled")}o&&($(".eventsCalendar-daysList li.current a").attr("class","calendar-day-not-available"),$(".eventsCalendar-day a").attr("class",""),$("#dayList_"+s+" a").attr("class",""),$("div.eventsCalendar-subtitle").html(""),$("div.eventsCalendar-subtitle")[0].style.height=""),""!=s&&r.length?(flags.wrap.find(".eventsCalendar-noEvents").hide(),subtitle.html('<img class="arrow-select-hour" src="/img/arrow-select-hour.png?20161020"/><span class="arrow-select-hour">'+eventsOpts.txt_SelectHour+"</span>"),$("img.arrow-select-hour").animate({height:"30px"},500,function(){$("img.arrow-select-hour").animate({height:"22px"},250,function(){$("img.arrow-select-hour").animate({height:"27px"},150,function(){$("img.arrow-select-hour")[0].style.height="30px"})})})):subtitle.html("")}else blankMonthAutoSkips&&(setTimeout(function(){$("a."+blankMonthAutoSkipsDirection).trigger("click")},550),blankMonthAutoSkips--);r.length||(r.push('<li class="eventsCalendar-noEvents"><p>'+eventsOpts.txt_SelectDay+'&nbsp;&nbsp; <img class="arrow-select-day" src="/img/arrow-select-day.png?20161020"/></p></li>'),$("img.arrow-select-day").animate({height:"36px"},500,function(){$("img.arrow-select-day").animate({height:"28px"},250,function(){$("img.arrow-select-day").animate({height:"32px"},150,function(){$("img.arrow-select-day")[0].style.height="36px"})})})),flags.wrap.find(".eventsCalendar-list").html(r.join("")),$("input.hour-to-select").click(function(e){$("body").css("cursor","wait"),setTimeout(function(){$("body").css("cursor","auto")},1e3),$("img.arrow-select-ticket").animate({height:"30px"},500,function(){$("img.arrow-select-ticket").animate({height:"22px"},250,function(){$("img.arrow-select-ticket").animate({height:"27px"},150,function(){$("img.arrow-select-ticket")[0].style.height="30px"})})});var t=this.value;this.id.substr(5,10);return $("input:hidden[name=hour]:hidden").val(t),!1}),1==$("input.hour-to-select").length&&setTimeout(function(){$("input.hour-to-select").trigger("click"),updateBox()},700),flags.wrap.find(".eventsCalendar-list").animate({opacity:1,height:"toggle"},eventsOpts.moveSpeed)}),setCalendarWidth()}function convertTimeTo24(e){var t=!1,a=!1;e.match("pm")&&(t=!0),e.match("am")&&(a=!0);e=e.replace(/am|pm$/,"");return e=e.split(":"),hours=e[0],minutes=e[1],t&&(hours=12+parseInt(hours,10)),a&&"12"===hours&&(hours="00"),"".concat(hours,":").concat(minutes)}function changeMonth(){flags.wrap.find(".arrow").click(function(e){if(e.preventDefault(),$("body").css("cursor","wait"),setTimeout(function(){$("body").css("cursor","auto")},1e3),changeMonthOcuppied)return!1;if(changeMonthOcuppied=!0,setTimeout(function(){changeMonthOcuppied=!1},500),$("input:hidden[name=date]").val(""),$("input:hidden[name=hour]").val(""),updateBox(),$(this).hasClass("next")){if(deselect(),!(monthsForward<eventsOpts.monthsForwardLimit))return;monthsForward++,blankMonthAutoSkipsDirection="next",dateSlider("next");var t="-="+flags.directionLeftMove}else{if(!(monthsForward>0)){if(eventsOpts.blankMonthAutoSkips){var a='<div id="messagePreviously" class="messagepop pop"><p>'+eventsOpts.txt_PreviouslyMessage+"</p></div>";return $("#messagePreviously").length>0||$(".eventsCalendar-slider").append(a),$(this).hasClass("selected")||($(this).addClass("selected"),$(".pop").slideFadeToggle(),setTimeout(function(){deselect()},4e3)),!1}return}monthsForward--,blankMonthAutoSkipsDirection="prev",dateSlider("prev");t="+="+flags.directionLeftMove}flags.wrap.find(".eventsCalendar-monthWrap.oldMonth").animate({opacity:eventsOpts.moveOpacity,left:t},eventsOpts.moveSpeed,function(){flags.wrap.find(".eventsCalendar-monthWrap.oldMonth").remove()})})}function deselect(){$(".pop").slideFadeToggle(function(){$(".arrow.prev").removeClass("selected"),$("#messagePreviously").remove()})}function showError(e){flags.wrap.find(".eventsCalendar-list-wrap").html("<span class='eventsCalendar-loading error'>"+e+"</span>")}function setCalendarWidth(){flags.directionLeftMove=flags.wrap.width(),flags.wrap.find(".eventsCalendar-monthWrap").width(flags.wrap.width()-5+"px"),flags.wrap.find(".eventsCalendar-list-wrap").width(flags.wrap.width()-5+"px")}function setCalendarWidgetHeight(){setTimeout(function(){var e=$("div.eventsCalendar-monthWrap").height();e&&$("div.eventsCalendar-slider").css("height",e)},1500)}var stopSkipMonthLoad=!1,eventsOpts=$.extend({},$.fn.eventCalendar.defaults,options),monthsForward=0,blankMonthAutoSkips=eventsOpts.blankMonthAutoSkips,blankMonthAutoSkipsDirection="next",fallbackEventsMode=!0,changeMonthOcuppied=!1,flags={wrap:"",directionLeftMove:"300",eventsJson:{}};this.each(function(){if(flags.wrap=$(this),flags.wrap.addClass("eventCalendar-wrap").append("<div class='eventsCalendar-list-wrap'><div class='eventsCalendar-subtitle'></div><div class='eventsCalendar-list-content'><ul class='eventsCalendar-list'></ul></div></div>"),eventsOpts.eventsScrollable&&flags.wrap.find(".eventsCalendar-list-content").addClass("scrollable"),setCalendarWidth(),$(window).resize(function(){setCalendarWidth()}),dateSlider("current"),eventsOpts.showFromDate){var e=eventsOpts.showFromDate.getFullYear(),t=eventsOpts.showFromDate.getMonth(),a=1;getEvents(eventsOpts.eventsLimit,e,t,a,!1)}else getEvents(eventsOpts.eventsLimit,!1,!1,!1,!1);changeMonth();var n=1==$("input[name=show_closed_by_availability]").val(),s=".eventsCalendar-day.dayWithEvents a";n&&($(".eventsCalendar-day.too-late a").css("pointer-events","auto"),$(".eventsCalendar-day.too-late").css("pointer-events","auto"),s+=", .eventsCalendar-day.too-late a"),$(document).on("click",s,function(e){$(".eventsCalendar-day a").css("pointer-events","none"),$("body").css("cursor","wait"),setTimeout(function(){$(".eventsCalendar-day a").css("pointer-events","auto"),$(".disabled a").css("pointer-events","none"),$("body").css("cursor","auto")},2e3),e.preventDefault();var t=flags.wrap.attr("data-current-year"),a=flags.wrap.attr("data-current-month"),n=$(this).parent().attr("rel"),s="";$(this).parent("li").hasClass("calendar-hide-hour")&&"0"===$("input[name=product_display_hours]").val()?(s=$(this).parent("li").data("hour"),$("input[name=hide_hour]").val(1)):$("input[name=hide_hour]").val(0),$("div.booking-box-right-1").addClass("opacity-hi");var r=parseInt(a)+1;r=r.toString(),1==r.length&&(r="0"+r);var l=n.toString();1==l.length&&(l="0"+l),$("input:hidden[name=date]")[0].value=t+"-"+r+"-"+l,$("input:hidden[name=hour]")[0].value="",updateBox(t+"-"+r+"-"+l,s),$(".calendar-day-selected").removeClass("calendar-day-selected"),$("#dayList_"+n).addClass("calendar-day-selected"),$("select[name*=ticket_type_count]").each(function(){$("#"+this.id)[0].disabled=!0,$("#"+this.id+" option")[0].selected=!0}),$("img.arrow-select-ticket")[0].style.height="0px",$("div.ticket-warning").hide(),$("div.eventsCalendar-subtitle")[0].style.height="2em",$(".eventsCalendar-noEvents").hide(),s||(getEvents(!1,t,a,n,"day"),$(".eventsCalendar-list-wrap").show())})}),$.fn.slideFadeToggle=function(e,t){return this.animate({opacity:"toggle",height:"toggle"},"fast",e,t)}},$.fn.eventCalendar.defaults={eventsjson:"js/events.json",eventsLimit:4,monthNames:["January","February","March","April","May","June","July","August","September","October","November","December"],dayNames:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],dayNamesShort:["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],txt_NotAvailable:"Not available",txt_CallToConsultAvailabilty:"Call to consult availability",txt_SelectDay:"Select day",txt_SelectHour:"Select hour",txt_Loading:"Loading",txt_errorTryAgain:"Error - please try again",txt_SpecificEvents_prev:"",txt_SpecificEvents_after:"",txt_next:"",txt_prev:"",txt_NextEvents:"",txt_GoToEventUrl:"",showFromDate:!1,showToDate:!1,showDayAsWeeks:!0,startWeekOnMonday:!0,showDayNameInCalendar:!0,showDescription:!1,onlyOneDescription:!0,openEventInNewWindow:!1,eventsScrollable:!1,monthsForwardLimit:24,blankMonthAutoSkips:24,moveSpeed:300,moveOpacity:.1,jsonData:"",cacheJson:!0,changeMonth:!0,changeYear:!0};